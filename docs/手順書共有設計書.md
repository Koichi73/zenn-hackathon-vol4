# 手順書共有機能 設計書

## 概要
作成した手順書を外部ユーザー（閲覧者）に共有するための機能である。
ユーザーが手順書を保存した時点で一意のID（共有用URL）が発行され、URLを知っている全員がログイン不要で閲覧できる仕組みを提供する。

## 機能要件
1. **共有URLの発行**
   - 保存時に `マニュアルID + 作成日時` を組み合わせた一意のIDが生成される。
   - 例: `videotitle_20260125171447`

2. **閲覧**
   - 閲覧者は `https://[ドメイン]/share/[id]` から手順書を閲覧可能。
   - **ログイン不要**: 公開ページのため、誰でもアクセス可能である。
   - **読み取り専用**: 閲覧専用のUI（`SharePage`）で表示される。

3. **公開設定（簡略化）**
   - 現在の仕様では、保存されたマニュアルはすべてURLを知っていれば閲覧可能である。

## 構成・技術スタック
- **Frontend**: Next.js (App Router)
- **Backend**: FastAPI (Python)
- **Database**: Firestore (Collection Group Queryを使用)
- **Storage**: Google Cloud Storage (マニュアルJSON、画像、動画の保存)

## システム構成図 / 処理フロー
1. **保存フロー**:
   - ユーザーが保存を実行。 `ManualSaveService` がGCSにデータをアップロードし、Firestoreにパスを保存する。
   - IDが確定（`{title}_{timestamp}`）。
2. **共有フロー**:
   - 作成者が `ShareManual` ダイアログからURLをコピーする。
3. **閲覧フロー**:
   - 閲覧者がURLにアクセスする。
   - フロントエンドが `getPublicManual(id)` を呼び出す。
   - バックエンドが Firestore の全ユーザーの `manuals` サブコレクションを検索（Collection Group）する。
   - 見つかったメタデータに基づき、GCSから詳細（ステップ情報）を取得して返却する。

## データ設計 (Firestore)
各ユーザーのドキュメント配下に `manuals` コレクションを持つ。

- パス: `users/{user_id}/manuals/{full_id}`
- 主なフィールド:
    - `id`: 一意のID（URLに使用）
    - `title`: タイトル
    - `gcs_json_path`: 手順ステップ詳細（JSON）へのパス
    - `gcs_video_path`: 動画ファイルへのパス
    - `updated_at`: 最終更新日時

### 注意点: インデックス
全ユーザーのサブコレクションを横断して `id` で検索するため、Firestoreで **COLLECTION_GROUP_ASC** インデックスが必要である。

## API設計
### `GET /api/public/manuals/{id}`
- **役割**: 公開用IDからマニュアルの詳細情報を取得する。
- **セキュリティ**: 
    - 画像等のアセットはGCSバケットを `allUsers` 閲覧可（Storage Object Viewer）に設定することで表示する。

## URL構造
- **共有ページ**: `/share/[id]`
- **API (Frontend)**: `@/api/manual.ts`
