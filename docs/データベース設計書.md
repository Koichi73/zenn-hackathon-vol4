# データベース・ストレージ設計

## 1. Google Cloud Storage (GCS) 設計

本アプリケーションでは、画像の永続化や動画、生成された手順書JSONの保存に Google Cloud Storage を使用する。

### 1.1. ディレクトリ構造
アセットの種類および生成タイミングごとにディレクトリを分けて管理する。

```text
manuals/
└── {full_id}/                          # 手順書ID
    ├── manual.json                     # 手順書データ本体
    ├── video.mp4                       # 手順書保存時に永続化された動画
    └── images/                         # 当該手順書に関連する画像
        ├── step_01.jpg
        ├── step_02.jpg
        └── ...
```

### 1.2. データの詳細

#### 手順書データ (JSON)
*   **パス**: `manuals/{full_id}/manual.json`
*   **用途**: 手順書の構成、各ステップのテキスト（タイトル・説明）、画像への参照URLの保持。
*   **保存ルール**: 手順書のエディタで「保存」ボタンが押されるたびに、その時点の `steps` データを JSON 化して指定パスに保存（上書きまたは新規バージョン）する。

#### スクリーンショット (Images)
*   **パス**: `manuals/{full_id}/images/{filename}`
*   **用途**: 手順書の各ステップにおける視覚的補助。
*   **保存フロー**: 
    1. 保存実行時、ローカルサーバー (`/static/`) に一時保存されている画像を `manuals/{full_id}/images/` 配下へアップロードする。
    2. JSON 内の `image_url` は、GCS 上の公開 URL に置換されてから JSON 本体の保存が行われる。

#### 元動画 (Videos)
*   **パス**: `manuals/{full_id}/video.mp4`
*   **用途**: 
    1. Gemini による動画構造解析のソース。
    2. 手順書閲覧時のプレビュー再生。
*   **保存フロー**: 
    *   手順書の保存ボタン押下時に、アップロードされた元動画を `manuals/{full_id}/video.mp4` として永続化する。

---

## 2. Firestore 設計

GCS上のファイルへの参照や、手順書のメタデータを管理するために Firestore を使用する。

### 2.1. 手順書コレクション (`manuals`)

プロジェクトごと、または保存バージョンごとのメタデータを保持する。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | string | ドキュメントID (`full_id` と同一) |
| `title` | string | 手順書の表示タイトル（ファイル名など） |
| `manual_id` | string | サニタイズされたベースID |
| `gcs_json_path` | string | GCS上の最新JSONファイルへのパス |
| `gcs_video_path` | string | GCS上の動画ファイルへのパス |
| `step_count` | number | 手順の数 |
| `created_at` | timestamp | 初回作成日時 |
| `updated_at` | timestamp | 最終保存日時 |
| `status` | string | `completed`, `error` 等の状態 |
| `user` | string | 手順書の所有者 |

### 2.2. フィードバックコレクション (`feedbacks`)

利用者からの「ここが古い」といった指摘情報を管理する。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `manual_db_id` | string | `manuals` コレクションのドキュメントIDへの参照 |
| `step_index` | number | 指摘対象の手順インデックス |
| `type` | string | 指摘の種類（「古い」「分かりにくい」等） |
| `comment` | string | 自由記述のコメント |
| `created_at` | timestamp | 投稿日時 |

---

## 3. ID 生成ルール
*   **`manual_id`**: アップロードされたファイル名から拡張子を除き、英数字とアンダースコアのみに変換（サニタイズ）したもの。
*   **`timestamp`**: 保存実行時の時刻 (`YYYYMMDDHHMMSS`)。
*   **`full_id`**: `{manual_id}_{timestamp}` の形式で、各保存のバージョンを一意に識別する。
